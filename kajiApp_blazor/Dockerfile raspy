# -----------------------
# ベースランタイム（ラズパイ用 ARM64）
FROM mcr.microsoft.com/dotnet/aspnet:8.0-arm64v8 AS base
WORKDIR /app
EXPOSE 2000
#EXPOSE 8080
#EXPOSE 8081

# -----------------------
# SDK イメージ（ビルド用）※ARM64
FROM mcr.microsoft.com/dotnet/sdk:8.0-arm64v8 AS build
ARG BUILD_CONFIGURATION=Release
WORKDIR /src

# プロジェクトファイルをコピー（順序重要）
COPY ["kajiApp_blazor/kajiApp_blazor.csproj", "kajiApp_blazor/"]
COPY ["kajiapp.Domain/kajiapp.Domain.csproj", "kajiapp.Domain/"]
COPY ["kajiapp.Infra/kajiapp.Infra.csproj", "kajiapp.Infra/"]

# SQLite ファイルをビルド環境にコピー
COPY "kajiApp_blazor/database.db" "./database.db"

# パッケージ復元
RUN dotnet restore "kajiApp_blazor/kajiApp_blazor.csproj"

# ソースコード全体をコピー
COPY . .

# ビルド（ここで DLL が出る）
WORKDIR "/src/kajiApp_blazor"
RUN dotnet build "kajiApp_blazor.csproj" -c $BUILD_CONFIGURATION -o /app/build

# -----------------------
# 実行用ステージ（ビルド済DLLを使う）
FROM base AS final
WORKDIR /app

# ビルド成果物をコピー（DLL群）
COPY --from=build /app/build ./
COPY --from=build /src/database.db ./database.db

# アプリケーション実行
ENTRYPOINT ["dotnet", "kajiApp_blazor.dll"]
