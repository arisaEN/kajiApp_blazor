@using kajiApp_blazor.Components.Models.EatModel
@using kajiApp_blazor.Components.DatabaseContext.EatDBC



@* //明細入力画面 *@
@if (isInputVisible)
{
    <div class="input-group mt-3">
        <span class="input-group-text">@selectedYear / @selectedMonth</span>
        <input type="number" class="form-control" @bind="newAmount" placeholder="金額を入力" />
        <button class="btn btn-primary" @onclick="SaveNewRecord">保存</button>
    </div>
}
else
{
    <div class="input-placeholder text-center text-muted fade-in">
        <p>「入力」ボタンを押してデータを追加してください</p>
        <div class="placeholder-box"></div>
    </div>
}

@* //一覧 *@

@if (isLoading)
{
    <!-- ぐるぐるマークを表示 -->
    <div class="d-flex justify-content-center">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (eatrecord == null || !eatrecord.Any())
{
    <p class="text-center text-white">記録がありません</p>
}
else
{
    <div class="table-responsive">
        <table class="table table-bordered table-striped w-100 eat-table text-white bg-dark">
            <thead class="table-dark text-center">
                <tr>
                    <th class="text-white">年</th>
                    <th class="text-white">月</th>
                    <th class="text-white">金額</th>
                    <th class="text-white">操作</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var e in eatrecord)
                {
                    <tr class="text-center text-white">
                        <td>@e.year</td>
                        <td>@e.month</td>
                        <td>@e.amount</td>
                        <td>
                            <button class="btn btn-success" @onclick="() => ShowInputForm(e.year, e.month)">入力</button>
                            <button class="btn btn-warning" @onclick="() => ShowEditForm(e.year, e.month)">編集</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@if (isEditVisible && editRecords != null)
{
    <div class="mt-3">
        <h5>編集: @selectedYear / @selectedMonth</h5>
        <table class="table table-bordered text-white">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>金額</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var record in editRecords)
                {
                    <tr>
                        <td>@record.id</td>
                        <td><input type="number" class="form-control" @bind="record.amount" /></td>
                        <td><button class="btn btn-primary" @onclick="() => UpdateRecord(record)">更新</button></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {

    [Parameter] public List<Models.EatModel.EatRecord>? eatrecord { get; set; }
    [Inject] private HttpClient Http { get; set; } = default!;
    [Inject] private AppState AppState { get; set; } = default!;

    private bool isLoading = false;



    private bool isInputVisible = false;
    private bool isEditVisible = false;
    private int selectedYear;
    private int selectedMonth;
    private int newAmount;
    private List<EatDetailRecord>? editRecords;

    private async Task ShowInputForm(int year, int month)
    {
        selectedYear = year;
        selectedMonth = month;
        isInputVisible = true;
        isEditVisible = false;
    }

    ///明細保存ボタンを押したときの処理
    private async Task SaveNewRecord()
    {
        var eatDetailEdit = new EatDetailEdit();
        await eatDetailEdit.InsertEatDetailAsync(selectedYear, selectedMonth, newAmount);
        await eatDetailEdit.EatDetailSumAsync();

        // 最新の食費記録を取得
        var eatRecordShow = new EatRecordShow();
        await eatRecordShow.GetEatAsync();

        isInputVisible = false;
    }

    private async Task ShowEditForm(int year, int month)
    {
        selectedYear = year;
        selectedMonth = month;
        isEditVisible = true;
        isInputVisible = false;
        // editRecords = await EatDB.GetEatDetailAsync(year, month);
    }

    private async Task UpdateRecord(EatDetailRecord record)
    {
        // await EatDB.UpdateEatDetailAsync(record.Id, record.Amount);
    }
}
